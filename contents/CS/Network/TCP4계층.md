# TCP/IP 4계층

장치가 인터넷 상에서 데이터를 주고받을 때 쓰는 독립적인 프로토콜의 집합이다. <br />
TCP/IP는 TCP(Transmission Control Protocol) / IP(Internet Protocol)이라는 의미다. <br />
인터넷을 통해 데이터를 보낼 때, 주로 TCP와 IP를 이용해 보내기 때문에 이런 용어를 가진다.

1. Application 계층 (SMTP, HTTP/HTTPS, FTP, SSH) <br />
2. Transport 계층 (UDP, TCP) <br />
3. Internet 계층 (IPv4, IPv6, ICMP, ARP) <br />
4. Network Access 계층

여기서 네트워크 접속 계층은 링크 계층이라고도 불린다.

### 애플리케이션 계층

HTTP, SMTP, SSH, FTP가 대표적이다. <br />
웹 서비스, 이메일 등 서비스를 실질적으로 사람들에게 제공하는 층이다. <br />

1. HTTP (Hypertext Transfer Protocol) <br />
   처음에는 서버와 브라우저 간에 데이터를 주고 받기 위해 설계된 프로토콜이다. <br />
   지금은 브라우저 뿐만 아니라, 서버와 서버간의 통신에도 많이 이용한다.

   - HTTP는 헤더를 통한 확장이 쉽다. <br />
   - HTTP는 상태를 저장하지 않는다. 연속된 상태, state값이 없다.

2. SSH (Secure Shell Protocol) <br />
   보안되지 않은 네트워크에서 네트워크 서비스를 안전하게 운영하기 위한 암호화 네트워크 프로토콜이다. <br />
   보통 프라이빗 키가 있는 경로에서 키를 명시하고 실행한다.<br />
   파일을 전송할 수도 있다.

   ```
   <!-- 접속 -->
   ssh -i <프라이빗 키 경로 (pem 경로)> <접근할 곳 (ec2-user)>

   <!-- 파일 전송 -->
   scp <source> <destination>
   ```

3. FTP (File Transfer Protocol) <br />
   노드와 노드간의 파일을 전송하는데 사용된다. <br />
   지금은 파일을 암호화해서 전송하는 FTPS 또는 SFTP로 대체되고 있다.

4. SMTP (Simple Mail Transfer Protocol) <br />
   인터넷을 통해 메일을 보낼 때 사용된다. <br />
   메일링 서비스를 하게 된다면 이를 통해 보내야 한다. <br />
   자바스크립트 진영에는 `Nodemailer`라는 라이브러리가 있다.
   ```javascript
   let transporter = nodemailer.createTransport({
     host: "smtp.ethereal.email",
     port: 587,
     secure: false, // true for 465, false for other ports
     auth: {
       user: testAccount.user, // generated ethereal user
       pass: testAccount.pass, // generated ethereal password
     },
   });
   ```

### 전송 계층

TCP, UDP가 대표적이다. <br />
애플리케이션 계층에서 받은 메시지를 기반으로 **세그먼트** 혹은 **데이터그램**으로 데이터를 쪼갠다. <br />
그리고 그 데이터가 오류없이 순서대로 전달되도록 도움을 주는 계층이다.

1. TCP <br />

   - 가상회선 패킷 교환 방식 <br />
   - 오류검사 매커니즘 <br />
     1. 재전송 : 시간 초과 기간이 지나면, 서버는 전달되지 않은 데이터를 재전송 시도한다. <br />
     2. 체크섬 : 체크섬을 통해 무결성을 평가한다. 송신된 데이터의 체크섬과 수신된 데이터의 체크섬 값을 비교해서 올바르게 왔는지 확인한다.<br />
   - 헤더 <br />
     20 ~ 60 바이트로 가변적이다.<br />
   - 신뢰성이 있다. 패킷 순서를 보장하기 떄문이다. <br />
   - 브로드 캐스트 지원하지 않는다. <br />
   - 속도가 느리다.<br />
   - 연결을 보장한다. (3웨이-핸드셰이크로 연결, 4웨이-핸드셰이크로 해제)

2. UDP <br />
   - 데이터그램 패킷 교환 방식 <br />
   - 오류검사는 단순한 체크섬만 지원한다. <br />
   - 헤더 <br />
     8바이트로 고정길이를 가진다.<br />
   - 신뢰성이 없다. 패킷 순서를 보장하지 않기 때문이다. <br />
   - 브로드 캐스트를 지원한다. <br />
   - 속도가 빠르다. <br />
   - 연결 보장하지 않고, 일단 데이터를 보낸다.

### 인터넷 계층

IP, ICMP, ARP가 대표적이다. <br />
한 노드에서 다른 노드로 전송 계층에서 받은 데이터(세그먼트, 데이터그램)을 **패킷화**해서 목적지로 전송하는 역할을 담당한다.

- ICMP (Internet Control Message Protocol) <br />
  노드와 노드 사이에서 통신이 잘되나를 확인할 때 쓰이는 프로토콜이다. <br />
  데이터를 교환할 때는 사용하지 않는다. <br />
  일반적으로 테스팅할 떄 사용된다. <br />
  IP와는 달리, TCP 또는 UDP와 같은 전송 계층 프로토콜과 연관되지 않는다. <br />
  독립적인 비연결형 프로토콜이다.

### 링크 계층

전선, 광섬유, 무선 등으로 데이터가 네트워크를 통해 물리적으로 전송되는 방식을 정의한다. <br />
데이터 링크 계층과 물리 계층을 합친 계층이다.

## 캡슐화와 비캡슐화

네트워크에서 캡슐화란? <br />
송신자가 수신자에게 데이터를 보낼 때, 데이터가 각 계층을 지나며, 각 계층의 특징들이 담긴 헤더들이 붙여지는 과정이다. <br />
예를 들어, 전송 계층은 `TCP 헤더`, 네트워크 계층은 `IP 주소 헤더`를 추가하는 거다. <br />

비캡슐화는 이 과정의 역과정이다. <br />
수신자측에서는 이렇게 캡슐화된 데이터를 역순으로 제거하면서 애플리케이션 계층까지 도달하는 것이다.

## PDU (protocol data unit)

TCP/IP 4계층을 기반으로 설명했을 때, 각 계층의 데이터 단위를 의미한다.

- 애플리케이션 계층 : 메세지 <br />
- 전송 계층 : 세그먼트(TCP), 데이터그램(UDP) <br />
- 인터넷 계층 : 패킷 <br />
- 링크 계층 : 프레임(데이터 링크 계층), 비트(물리 계층)

`세그먼트` : 적절한 크기로 쪼갠 조각 (데이터그램도 의미 동일함) <br />
`패킷` : 세그먼트에 SP, DP가 포함된 IP 헤더가 붙은 형태의 조각 <br />
`프레임` : MAC 주소 헤더와 CRC/체크섬 트레일러가 붙은 조각 <br />
`SP`: (IPv4 기준) 송신자의 32비트 IP주소 <br />
`DP`: (IPv4 기준) 수신자의 32비트 IP주소

## CRC/체크섬 트레일러

데이터 오류감지를 위한 수학적 함수가 적용된 값이 있는 필드다. <br />
링크의 오류(과도한 트래픽 등)로 인해 데이터 손상을 감지하는 역할을 한다. <br />
이 과정에서 CRC와 체크섬 두 가지의 과정을 기반으로 `데이터 전송 오류`, `데이터 무결성`을 보장한다. (둘 다 비슷하다)

- CRC : CRC-1, CRC-16 등의 알고리즘으로 나온 값을 통해 `데이터 전송 오류 감지`를 수행한다. <br />
- 체크섬 : MD5, SHA-256 등의 알고리즘으로 나온 값을 통해 `데이터 무결성`을 보장한다.

참고로 모든 계층에 전달되는 데이터가 쪼개져서 "패킷"으로 전달된다고 하는 것도 대강 맞지만, PDU에 따라 부르는 게 더 맞다.

## OSI 7계층

TCP/IP 4계층은 OSI 7계층 모델로 설명되기도 한다. <br />
TCP/IP 계층과 달리, OSI 7계층은 `애플리케이션 계층을 3개`로 쪼갠다. <br />
`링크 계층`을 `데이터 계층`과 `물리 계층`으로 나뉜다. <br />
`인터넷 계층`을 `네트워크 계층`으로 부른다는 차이가 있다.

애플리케이션 계층 = 애플리케이션, 프레젠테이션, 세션 계층

---

## MTU(Maximum Transmission Unit)

네트워크에 연결된 장치가 받아들일 수 있는 최대 데이터 패킷의 크기다. <br />
이 크기를 기준으로 데이터가 쪼개져서 패킷화된다. <br />
네트워크 경로 상에 있는 장치의 MTU보다 패킷이 크면, 그 패킷은 분할될 수도 있다.

### 패킷이 분할되지 않는 경우

패킷을 분할할 수 없는데, 네트워크 경로 상에 있는 라우터나 장치의 MTU를 초과한다면 전달하지 않을 수도 있다.

- IPv6 : 분할을 허용하지 않는다. <br />
- IPv4 : `flag`라는 헤더 필드가 있다. 여기서 `bit 1`이 되면 `Don't Fragment`플래그가 활성화되는데, 이때는 분할이 불가능하다.

## MTU와 MSS

MTU는 IP헤더와 TCP헤더의 크기까지 합친다. <br />
MSS(Maximum Segment Size)는 데이터의 크기(payload 크기)만을 가리킨다.

MTU = payload + IP헤더 + TCP헤더 <br />
MSS = payload

일반적으로 MTU는 1,500 바이트고, MSS는 1,460 바이트다. <br />
네트워크를 통해 데이터를 보낼 때, MTU가 1,500이더라도 데이터는 보통 1,460바이트 이하의 크기로 보내야 전송이 된다. <br />
다만, TCP를 쓰지 않는다는 등의 이유로 달라질 수도 있다.

## PMTUD (Path MTU Discovery)

수신자와 송신자의 경로 상에서 장치가 패킷을 누락한 경우, 테스트 패킷의 크기를 낮추면서 MTU에 맞게끔 반복해서 보내는 과정을 의미한다.
